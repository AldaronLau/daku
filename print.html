<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Daku API Specification</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="daku.html"><strong aria-hidden="true">2.</strong> Daku Custom Section</a></li><li class="chapter-item expanded "><a href="channel.html"><strong aria-hidden="true">3.</strong> Channel Allocation</a></li><li class="chapter-item expanded "><a href="api.html"><strong aria-hidden="true">4.</strong> Base API</a></li><li class="chapter-item expanded "><a href="types.html"><strong aria-hidden="true">5.</strong> Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="list.html"><strong aria-hidden="true">5.1.</strong> List</a></li><li class="chapter-item expanded "><a href="text.html"><strong aria-hidden="true">5.2.</strong> Text</a></li><li class="chapter-item expanded "><a href="vector.html"><strong aria-hidden="true">5.3.</strong> Vector</a></li><li class="chapter-item expanded "><a href="dimensions.html"><strong aria-hidden="true">5.4.</strong> Dimensions</a></li><li class="chapter-item expanded "><a href="raster.html"><strong aria-hidden="true">5.5.</strong> Raster ðŸ§ª</a></li><li class="chapter-item expanded "><a href="positions.html"><strong aria-hidden="true">5.6.</strong> Positions ðŸ§ª</a></li><li class="chapter-item expanded "><a href="audio.html"><strong aria-hidden="true">5.7.</strong> Audio ðŸ§ª</a></li></ol></li><li class="chapter-item expanded "><a href="portals.html"><strong aria-hidden="true">6.</strong> Portals</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="log.html"><strong aria-hidden="true">6.1.</strong> 0x00 - Log</a></li><li class="chapter-item expanded "><a href="prompt.html"><strong aria-hidden="true">6.2.</strong> 0x01 - Prompt</a></li><li class="chapter-item expanded "><a href="fetch.html"><strong aria-hidden="true">6.3.</strong> 0x02 - Fetch ðŸ§ª</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="host.html"><strong aria-hidden="true">6.3.1.</strong> Device/Host ðŸ§ª</a></li></ol></li><li class="chapter-item expanded "><a href="serve.html"><strong aria-hidden="true">6.4.</strong> 0x03 - Serve ðŸ§ª</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="client.html"><strong aria-hidden="true">6.4.1.</strong> Device/Client ðŸ§ª</a></li></ol></li><li class="chapter-item expanded "><a href="speakers.html"><strong aria-hidden="true">6.5.</strong> 0x04 - Speakers ðŸ§ª</a></li><li class="chapter-item expanded "><a href="microphone.html"><strong aria-hidden="true">6.6.</strong> 0x05 - Microphone ðŸ§ª</a></li><li class="chapter-item expanded "><a href="screen.html"><strong aria-hidden="true">6.7.</strong> 0x06 - Screen ðŸ§ª</a></li><li class="chapter-item expanded "><a href="camera.html"><strong aria-hidden="true">6.8.</strong> 0x07 - Camera ðŸ§ª</a></li><li class="chapter-item expanded "><a href="window.html"><strong aria-hidden="true">6.9.</strong> 0x08 - Window ðŸ§ª</a></li><li class="chapter-item expanded "><a href="spawn.html"><strong aria-hidden="true">6.10.</strong> 0x09 - Spawn ðŸ§ª</a></li><li class="chapter-item expanded "><a href="user.html"><strong aria-hidden="true">6.11.</strong> 0x0A - User ðŸ§ª</a></li><li class="chapter-item expanded "><a href="preferences.html"><strong aria-hidden="true">6.12.</strong> 0x0B - Preferences ðŸ§ª</a></li><li class="chapter-item expanded "><a href="system.html"><strong aria-hidden="true">6.13.</strong> 0x0C - System ðŸ§ª</a></li><li class="chapter-item expanded "><a href="about.html"><strong aria-hidden="true">6.14.</strong> 0x0D - About ðŸ§ª</a></li><li class="chapter-item expanded "><a href="file.html"><strong aria-hidden="true">6.15.</strong> 0x0E - File ðŸ§ª</a></li><li class="chapter-item expanded "><a href="hid.html"><strong aria-hidden="true">6.16.</strong> 0x0F - Hid ðŸ§ª</a></li><li class="chapter-item expanded "><a href="timer.html"><strong aria-hidden="true">6.17.</strong> 0x10 - Timer ðŸ§ª</a></li><li class="chapter-item expanded "><a href="clock.html"><strong aria-hidden="true">6.18.</strong> 0x11 - Clock ðŸ§ª</a></li><li class="chapter-item expanded "><a href="gpu.html"><strong aria-hidden="true">6.19.</strong> 0x12 - Gpu ðŸ§ª</a></li><li class="chapter-item expanded "><a href="location.html"><strong aria-hidden="true">6.20.</strong> 0x13 - Location ðŸ§ª</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Daku API Specification</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Daku is an asynchronous system interface API for WebAssembly with a focus on
multimedia.  Some goals may overlap with WASI, others do not.  It is developed
as a supporting specification for the Ardaku project.</p>
<p>It will be possible to make a fully-featured compatibility layer to implement
WASI over Daku, and Daku over WASI once asynchronous APIs are implemented in
WASI.</p>
<h2 id="daku-specification-v100-pre0-draft-v4"><a class="header" href="#daku-specification-v100-pre0-draft-v4">Daku Specification v1.0.0-pre.0 (draft v4)</a></h2>
<p>The current version of Daku targets the full WebAssembly 2.0 spec without any
non-standard or experimental features.</p>
<h2 id="terminology"><a class="header" href="#terminology">Terminology</a></h2>
<h3 id="channel"><a class="header" href="#channel">Channel</a></h3>
<p>In Daku, a channel is a type that can have data sent over it.  One can not
receive data over a channel; To &quot;receive&quot; data, the Daku program must first send
a memory address of a buffer to the host.  After that, the channel may become
&quot;ready&quot; and the buffer filled with new data.</p>
<h3 id="portal"><a class="header" href="#portal">Portal</a></h3>
<p>A portal is an interface to some type of hardware on the host.  A portal
represents the hardware directly rather than the Unix-like method of abstracting
it as a path or URI.  Portals are built in to the Daku specification as an
abstraction over a channel.  Some channels are portals, while other channels
usually represent devices found over that portal.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="daku-custom-section"><a class="header" href="#daku-custom-section">Daku Custom Section</a></h1>
<p>The Daku custom section is a WebAssembly custom section that must follow the
order of conventional sections</p>
<ol>
<li><code>name</code></li>
<li><code>producers</code></li>
<li><code>target_features</code></li>
<li><code>daku</code></li>
</ol>
<p>The base section without extensions is just a WebAssembly vector of portal IDs.</p>
<p>For details on the experimental nucleide extension see
<a href="https://docs.rs/nucleide/latest/nucleide/#daku-daku">https://docs.rs/nucleide/latest/nucleide/#daku-daku</a></p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="channel-allocation"><a class="header" href="#channel-allocation">Channel Allocation</a></h1>
<p>Channels are implicitly allocated.  Channel 0 is always a custom channel that
can send arbitrary messages to the parent task or embedder.  This feature is
useful for plugin support in applications.  The first portal listed in the &quot;Daku
custom section&quot; will reserve channel 1.  All portal channels stay open for the
lifetime of the application/task.</p>
<p>Additional channels called device channels can be both opened and closed.  They
must be opened from a portal.  When they are closed, they go to a
&quot;garbage list&quot;.  Once a new device channel is opened, the last closed channel id
is reused for the new channel.  Channels are otherwise opened in consecutive
ascending order.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="base-api"><a class="header" href="#base-api">Base API</a></h1>
<p>For all APIs, addresses in memory refer to the memory exported as <code>memory</code>.
All Daku types are lists of packed 32-bit little-endian values.</p>
<p>The exported WebAssembly API contains a single function:</p>
<h2 id="function-ar"><a class="header" href="#function-ar"><em>Function</em>: <code>ar()</code></a></h2>
<p>Retconned from &quot;Ardaku&quot;; Asynchronous Request function.</p>
<p>Returns once at least one command (with a non-zero <code>ready</code> value) completes.  An
early return can be forced with a <code>Pass</code> no-op command.</p>
<pre><code class="language-wat">(import &quot;daku&quot; &quot;ar&quot; (func $event
    (param $cmd_size i32)   ;; List[Command].size
    (param $cmd_addr i32)   ;; List[Command].addr
    (result i32)            ;; List[Uint32].size 
))
</code></pre>
<h3 id="parameters"><a class="header" href="#parameters">Parameters</a></h3>
<ul>
<li><code>$cmd_size</code> The size of the data pointed to by <code>$cmd_addr</code></li>
<li><code>$cmd_addr</code> A pointer in the wasm memory to a list of <code>$cmd_size</code> commands</li>
</ul>
<h3 id="returns"><a class="header" href="#returns">Returns</a></h3>
<ul>
<li>The number of ready channels in the ready list (new length of ready list).</li>
</ul>
<h2 id="type-command"><a class="header" href="#type-command"><em>Type</em>: <code>Command</code></a></h2>
<p>Commands are the way the Daku application sends messages to the environment.</p>
<h3 id="fields"><a class="header" href="#fields">Fields</a></h3>
<ul>
<li><code>size: int</code> Size of data pointed to by <code>addr</code>, in bytes.</li>
<li><code>addr: ptr</code> Pointer to <code>size</code> bytes to be sent as a command.</li>
<li><code>channel: int</code> The channel on which to send the command.</li>
<li><code>ready: val</code> Arbitrary non-zero 32-bit value to write to ready list, or zero
to forget.</li>
</ul>
<h2 id="type-ready-subtype-of-command"><a class="header" href="#type-ready-subtype-of-command"><em>Type</em>: <code>Ready</code> (subtype of <code>Command</code>)</a></h2>
<p>Update ready list.</p>
<h3 id="fields-1"><a class="header" href="#fields-1">Fields</a></h3>
<ul>
<li><code>size: int(0)</code> Empty buffer</li>
<li><code>addr: ptr(0)</code> Pointer to null</li>
<li><code>ready_size: int</code> Ready list size (non-zero)</li>
<li><code>ready_addr: ptr[int]</code> Ready list address (non-null)</li>
</ul>
<h2 id="type-pass-subtype-of-ready"><a class="header" href="#type-pass-subtype-of-ready"><em>Type</em>: <code>Pass</code> (subtype of <code>Ready</code>)</a></h2>
<p>No-op command.  Forces <code>ar()</code> to return immediately.</p>
<h3 id="fields-2"><a class="header" href="#fields-2">Fields</a></h3>
<ul>
<li><code>size: int(0)</code> Empty buffer</li>
<li><code>addr: ptr(0)</code> Pointer to null</li>
<li><code>ready_size: int(0)</code> Empty ready list</li>
<li><code>ready_addr: ptr(0)</code> Null ready list</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="types"><a class="header" href="#types">Types</a></h1>
<p>Daku defines a few shared types that can be used in the command definitions.
Occasionally, a command should use a custom type that packs data better, but it
should match similarly to another type defined here.</p>
<h2 id="primitives"><a class="header" href="#primitives">Primitives</a></h2>
<ul>
<li><code>val</code> An arbitrary untyped 32 bits</li>
<li><code>int</code> A 32-bit integer</li>
<li><code>float</code> A 32-bit floating point</li>
</ul>
<hr />
<ul>
<li><code>half</code> A 16-bit integer</li>
<li><code>byte</code> An 8-bit integer</li>
<li><code>nybl</code> A 4-bit integer</li>
</ul>
<hr />
<ul>
<li><code>ptr[T]</code> A 32-bit address</li>
<li><code>opt[T]</code> A 32-bit address or Null (0)</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="list"><a class="header" href="#list">List</a></h1>
<h2 id="type-listt"><a class="header" href="#type-listt"><em>Type</em>: <code>List[T]</code></a></h2>
<p>A list of elements of type <code>T</code>.</p>
<h3 id="fields-3"><a class="header" href="#fields-3">Fields</a></h3>
<ul>
<li><code>size: int</code> Number of elements pointed to at <code>addr</code>.</li>
<li><code>addr: ptr[T]</code> Packed list of <code>size</code> elements.</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="text"><a class="header" href="#text">Text</a></h1>
<h2 id="type-text"><a class="header" href="#type-text"><em>Type</em>: <code>Text</code></a></h2>
<p>A buffer of UTF-8 text.</p>
<h3 id="fields-4"><a class="header" href="#fields-4">Fields</a></h3>
<ul>
<li><code>size: int</code> Number of bytes pointed to at <code>addr</code>.</li>
<li><code>addr: ptr[byte]</code> UTF-8 string of <code>size</code> bytes.</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="vector"><a class="header" href="#vector">Vector</a></h1>
<h2 id="type-vector"><a class="header" href="#type-vector"><em>Type</em>: <code>Vector</code></a></h2>
<p>A 4-dimensional vector.</p>
<h3 id="fields-5"><a class="header" href="#fields-5">Fields</a></h3>
<ul>
<li><code>x: float</code> X position (-left +right)</li>
<li><code>y: float</code> Y position (-up +down)</li>
<li><code>z: float</code> Z position (-back +front)</li>
<li><code>w: float</code> W position (0 = vector, 1 = position)</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="dimensions"><a class="header" href="#dimensions">Dimensions</a></h1>
<h2 id="type-dimensions"><a class="header" href="#type-dimensions"><em>Type</em>: <code>Dimensions</code></a></h2>
<p>A 2-D integer width/height pair.</p>
<h3 id="fields-6"><a class="header" href="#fields-6">Fields</a></h3>
<ul>
<li><code>size: val</code> Dimensions pair
<ul>
<li><code>width: half</code> Width in pixels</li>
<li><code>height: half</code> Height in pixels</li>
</ul>
</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="raster"><a class="header" href="#raster">Raster</a></h1>
<h2 id="type-raster"><a class="header" href="#type-raster"><em>Type</em>: <code>Raster</code></a></h2>
<p>A buffer of pixels (image, picture, video, etc.).</p>
<h3 id="fields-7"><a class="header" href="#fields-7">Fields</a></h3>
<ul>
<li><code>size: Dimensions</code> Size of the image</li>
<li><code>addr: ptr</code> List of <code>size.width</code> * <code>size.height</code> pixels by row according to
format.</li>
<li><code>format: int</code> Bits per component
<ul>
<li><code>8</code> 8 bits (integer)</li>
<li><code>16</code> 16 bits (integer)</li>
<li><code>32</code> 32 bits (float)</li>
</ul>
</li>
<li><code>colorspace: int</code>
<ul>
<li><code>0</code> Mask (1 component - grayscale/alphascale)</li>
<li><code>1</code> RGBA (4 components)</li>
<li><code>2</code> BGRA (4 components)</li>
</ul>
</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="positions"><a class="header" href="#positions">Positions</a></h1>
<h2 id="type-positions"><a class="header" href="#type-positions"><em>Type</em>: <code>Positions</code></a></h2>
<p>A list of audio channel physical positions relative to the user at the origin.</p>
<p>The position must either be a unit vector (length of 1) or all zeros (center).</p>
<h3 id="fields-8"><a class="header" href="#fields-8">Fields</a></h3>
<ul>
<li><code>list: List[Vector]</code> - List of speakers / microphones in configuration.
<ul>
<li><code>x: float</code> - X position (-left +right)</li>
<li><code>y: float</code> - Y position (-up +down)</li>
<li><code>z: float</code> - Z position (-back +front)</li>
<li><code>w: float</code> - LFE? (0 = No, 1 = Yes)</li>
</ul>
</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="audio"><a class="header" href="#audio">Audio</a></h1>
<h2 id="type-audio"><a class="header" href="#type-audio"><em>Type</em>: <code>Audio</code></a></h2>
<p>A buffer of floating-point audio.</p>
<h3 id="fields-9"><a class="header" href="#fields-9">Fields</a></h3>
<ul>
<li><code>size: int</code> - Number of samples per channel.</li>
<li><code>addr: ptr</code> - Interleaved samples; List of <code>properties.count * size</code> 32-bit
floats.</li>
<li><code>properties: val</code> - Audio properties
<ul>
<li><code>rate: half</code> - Sample rate of the audio. (low).</li>
<li><code>rate: byte</code> - Sample rate of the audio. (high).</li>
<li><code>count: byte</code> - Number of channels.</li>
</ul>
</li>
<li><code>config: opt[Positions]</code> - Custom channel position configuration, default is
FLAC/SMPTE/ITU-R recommendations.</li>
</ul>
<h1 id="flacsmpteitu-r-recommendations"><a class="header" href="#flacsmpteitu-r-recommendations">FLAC/SMPTE/ITU-R recommendations</a></h1>
<ul>
<li>1 Channel: Mono (Mono)
<ol>
<li><code>(0, 0, 0, 0)</code></li>
</ol>
</li>
<li>2 Channels: Stereo (Left, Right)
<ol>
<li><code>(-1, 0, 0, 0)</code></li>
<li><code>(1, 0, 0, 0)</code></li>
</ol>
</li>
<li>3 Channels: Surround 3.0 (Left, Right, Center)
<ol>
<li><code>(-1, 0, 0, 0)</code></li>
<li><code>(1, 0, 0, 0)</code></li>
<li><code>(0, 0, 0, 0)</code></li>
</ol>
</li>
<li>4 Channels: Surround 4.0 (FrontL, FrontR, SurroundL, SurroundR)
<ol>
<li><code>(-0.5, 0, 0.8660254037844387, 0)</code></li>
<li><code>(0.5, 0, 0.8660254037844387, 0)</code></li>
<li><code>(-0.9396926207859084, 0, -0.3420201433256687, 0)</code></li>
<li><code>(0.9396926207859084, 0, -0.3420201433256687, 0)</code></li>
</ol>
</li>
<li>5 Channels: Surround 5.0 (FrontL, FrontR, Front, SurroundL, SurroundR)
<ol>
<li><code>(-0.5, 0, 0.8660254037844387, 0)</code></li>
<li><code>(0.5, 0, 0.8660254037844387, 0)</code></li>
<li><code>(0, 0, 1, 0)</code></li>
<li><code>(-0.9396926207859084, 0, -0.3420201433256687, 0)</code></li>
<li><code>(0.9396926207859084, 0, -0.3420201433256687, 0)</code></li>
</ol>
</li>
<li>6 Channels: Surround 5.1 (FrontL, FrontR, Front, Lfe, SurroundL, SurroundR)
<ol>
<li><code>(-0.5, 0, 0.8660254037844387, 0)</code></li>
<li><code>(0.5, 0, 0.8660254037844387, 0)</code></li>
<li><code>(0, 0, 1, 0)</code></li>
<li><code>(0, 0, 0, 1)</code></li>
<li><code>(-0.9396926207859084, 0, -0.3420201433256687, 0)</code></li>
<li><code>(0.9396926207859084, 0, -0.3420201433256687, 0)</code></li>
</ol>
</li>
<li>7 Channels: Surround 6.1 (FrontL, FrontR, Front, Lfe, Back, Left, Right)
<ol>
<li><code>(-0.5, 0, 0.8660254037844387, 0)</code></li>
<li><code>(0.5, 0, 0.8660254037844387, 0)</code></li>
<li><code>(0, 0, 1, 0)</code></li>
<li><code>(0, 0, 0, 1)</code></li>
<li><code>(0, 0, -1, 0)</code></li>
<li><code>(-1, 0, 0, 0)</code></li>
<li><code>(1, 0, 0, 0)</code></li>
</ol>
</li>
<li>8 Channels: Surround 7.1 (FrontL, FrontR, Front, Lfe, BackL, BackR, Left, Right)
<ol>
<li><code>(-0.5, 0, 0.8660254037844387, 0)</code></li>
<li><code>(0.5, 0, 0.8660254037844387, 0)</code></li>
<li><code>(0, 0, 1, 0)</code></li>
<li><code>(0, 0, 0, 1)</code></li>
<li><code>(-0.5, 0, -0.8660254037844387, 0)</code></li>
<li><code>(0.5, 0, -0.8660254037844387, 0)</code></li>
<li><code>(-1, 0, 0, 0)</code></li>
<li><code>(1, 0, 0, 0)</code></li>
</ol>
</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="portals"><a class="header" href="#portals">Portals</a></h1>
<p>Portals allow Daku applications to interface with the hardware and environment /
OS.  The environment is not required to grant access to all portals requested by
the application, and may either stop the application or mock out a fake
implementation to protect the user's privacy.</p>
<p>Implementations of portals should strive to be &quot;as mathematical&quot; as possible,
meaning that there's no fancy engineering abstractions - just sending and
receiving data and defining the required functionality.  This is to reduce the
risk for possibly needing to deprecating portals in the future.  That said, it's
ok to pack smaller pieces of data into one value if 32-bits can be guaranteed to
most likely never be needed.</p>
<p>Portals should also make use of shared high-level <a href="./types.html">types</a>.</p>
<h2 id="kinds"><a class="header" href="#kinds">Kinds</a></h2>
<p>Some portals only have one command that is sent on the channel to that portal.
But, there are some portals that can create new channels that accept different
commands and notify on different events.</p>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x00---log"><a class="header" href="#0x00---log">0x00 - Log</a></h1>
<p>Log a message with an associated target and log level, usually to help with
debugging.</p>
<h2 id="readiness"><a class="header" href="#readiness">Readiness</a></h2>
<p>Becomes ready once logging has completed (stopping the process after ready
wouldn't result in a partially-formed log message).</p>
<h2 id="command-log"><a class="header" href="#command-log"><em>Command</em>: <code>Log</code></a></h2>
<h3 id="fields-10"><a class="header" href="#fields-10">Fields</a></h3>
<ul>
<li><code>message: Text</code> - Message to print.</li>
<li><code>target: Text</code> Target name; First character is log level
<ul>
<li><code>F</code>: Fail (Trap the task)</li>
<li><code>E</code>: Error</li>
<li><code>W</code>: Warn</li>
<li><code>I</code>: Info</li>
<li><code>D</code>: Debug</li>
<li><code>T</code>: Trace</li>
</ul>
</li>
</ul>
<h3 id="traps"><a class="header" href="#traps">Traps</a></h3>
<ul>
<li>If log level character is invalid</li>
<li>If <code>message</code> is not valid UTF-8, or contains a NUL byte</li>
<li>If <code>target</code> is not valid UTF-8, or contains a NUL byte</li>
<li>If address at <code>message.addr + message.size</code> has no page</li>
<li>If address at <code>target.addr + target.size</code> has no page</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x01---prompt"><a class="header" href="#0x01---prompt">0x01 - Prompt</a></h1>
<p>Receive a line of textual user input from a debugging console.</p>
<p>The text appended to the buffer won't contain the newline character.</p>
<h2 id="readiness-1"><a class="header" href="#readiness-1">Readiness</a></h2>
<p>Becomes ready once either line of text has been entered.  With either</p>
<ol>
<li>Buffer is not big enough, with <code>capacity</code> modified to what is required</li>
<li>Buffer is big enough, <code>command</code> text overwritten.</li>
</ol>
<h2 id="command-prompt"><a class="header" href="#command-prompt"><em>Command</em>: <code>Prompt</code></a></h2>
<p>Read textual user input from some source.</p>
<h3 id="fields-11"><a class="header" href="#fields-11">Fields</a></h3>
<ul>
<li><code>capacity: ptr[int]</code> - (In/Out) Pointer to capacity of <code>command</code>.</li>
<li><code>command: ptr[Text]</code> - (In/Out) Pointer to user-sent line of input.</li>
</ul>
<h3 id="traps-1"><a class="header" href="#traps-1">Traps</a></h3>
<ul>
<li>If input <code>capacity</code> is less than <code>command.size</code></li>
<li>If address at (input) <code>command.addr + capacity</code> has no page</li>
<li>If address at <code>capacity + 3</code> has no page</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x02---fetch-"><a class="header" href="#0x02---fetch-">0x02 - Fetch ðŸ§ª</a></h1>
<p>Do an HTTPS request to specified URL.</p>
<p>SSE is expected to be implemented as an abstraction over this API (rather than
be provided as its own portal).</p>
<h2 id="connection"><a class="header" href="#connection">Connection</a></h2>
<p>Host device channel is opened upon readiness (allocated only if successful).
The channel allocation should happen immediately upon return of <code>ar()</code>, and must
follow in the order of the ready list.</p>
<h2 id="readiness-2"><a class="header" href="#readiness-2">Readiness</a></h2>
<p>Becomes ready once either</p>
<ul>
<li>The resource host can't be reached (network error), <code>capacity</code> set to 0.</li>
<li>The resource host hung up, <code>capacity</code> set to 0.</li>
<li>The resource host has sent back a chunk of the resource (a new device
channel has been opened)
<ol>
<li>Buffer is not big enough, <code>buffer</code> overwritten up to <code>capacity</code> bytes, and
<code>capacity</code> modified how many more bytes are required</li>
<li>Buffer is big enough, <code>buffer</code> overwritten, <code>capacity</code> unchanged.</li>
</ol>
</li>
</ul>
<h2 id="command-fetch"><a class="header" href="#command-fetch"><em>Command</em>: <code>Fetch</code></a></h2>
<h3 id="fields-12"><a class="header" href="#fields-12">Fields</a></h3>
<ul>
<li><code>url: Text</code> - URL to do an HTTPS request to (does not include <code>https://</code>
protocol)</li>
<li><code>headers: Text</code> - Extra headers to send (separated by <code>\n</code>)</li>
<li><code>body: opt[List[byte]]</code> - Optional payload/content body to send</li>
<li><code>method: int</code> - 0: GET, 1: HEAD, 2: POST, 3: PUT, 4: DELETE.</li>
<li><code>capacity: ptr[int]</code> - (In/Out) Pointer to capacity of <code>buffer</code>.</li>
<li><code>buffer: ptr[List[byte]]</code> - (In/Out) Pointer to buffer for receiving parts of
the HTTP response.</li>
</ul>
<h3 id="traps-2"><a class="header" href="#traps-2">Traps</a></h3>
<ul>
<li>If <code>url</code> does not start with one of
<ul>
<li>Domain name lowercase (ranged a~z or 0~9, <code>-</code> and <code>.</code> allowed after first
character, but not consecutively, and not last character before termination
character - one of <code>:/?</code>)</li>
<li>IPv4 Address - 4 integers ranged 0:255 each separated by <code>.</code>)</li>
<li>Ipv6 Address - <code>[</code>, then 8 lowercase hexaxecimal numbers from 1 to 4 digits
separated by <code>:</code>, and <code>]</code>.  A grouping of consecutive zero numbers can be
replaced with <code>::</code>, rather than requiring all 8 numbers.</li>
</ul>
</li>
<li>If <code>url</code> after domain/IP doesn't either start with one of <code>:/?</code> or end</li>
<li>If <code>url</code> sections <code>:/?</code> are out of order</li>
<li>If <code>url</code> port after <code>:</code> is not in range 0~65535</li>
<li>If <code>url</code> path after <code>/</code> is not <code>a~z</code>, <code>A~Z</code>, <code>-</code>, <code>_</code>, <code>%</code>, <code>.</code>, <code>~</code>, <code>+</code>,
or <code>/</code></li>
<li>If <code>url</code> query after <code>?</code> is not <code>a~z</code>, <code>A~Z</code>, <code>0~9</code>, <code>-</code>, <code>_</code> <code>.</code>, <code>~</code>, <code>+</code>,
<code>=</code>, <code>;</code>, or <code>&amp;</code></li>
<li>If <code>headers</code> begins with <code>\n</code> or ends with <code>\n</code></li>
<li>If <code>headers</code> line does not match <code>Title-Kebab-Case: expected-type</code> (no <code>\r</code>
allowed)</li>
<li>If <code>headers</code> line contains an invalid (Like <code>Not-A-Header</code>), redudant (Like
<code>Content-Length</code>), or insecure (Also like <code>Content-Length</code>) <code>header</code></li>
<li>If input <code>capacity</code> is less than <code>buffer.size</code></li>
<li>If address at (input) <code>buffer.addr + body.capacity</code> has no page</li>
<li>If address at <code>body.addr + body.size</code> has no page</li>
<li>If address at <code>url.addr + url.size</code> has no page</li>
<li>If address at <code>headers.addr + headers.size</code> has no page</li>
<li>If address at <code>body + 3</code> has no page</li>
<li>If address at <code>capacity + 3</code> has no page</li>
<li>If address at <code>buffer + 3</code> has no page</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="device-host-"><a class="header" href="#device-host-"><em>Device</em>: Host ðŸ§ª</a></h1>
<p>Channel representing an HTTPS connection to a server.</p>
<h2 id="type-fetcherror"><a class="header" href="#type-fetcherror"><em>Type</em>: <code>FetchError</code></a></h2>
<p>An error may be indicated once either <code>Fetch</code> or <code>Host</code> command becomes ready.</p>
<p>To indicate an error, <code>capacity</code> will be set to 0.  <code>buffer.size</code> will be set to
an error code:</p>
<h3 id="variants-int"><a class="header" href="#variants-int">Variants (<code>int</code>)</a></h3>
<ol start="0">
<li><code>Network</code> - Server unreachable (network error).</li>
<li><code>Hangup</code> - Server hung up.</li>
</ol>
<h2 id="readiness-3"><a class="header" href="#readiness-3">Readiness</a></h2>
<p>Becomes ready once either</p>
<ul>
<li>The resource host can't be reached (network error), <code>capacity</code> set to 0.</li>
<li>The resource host hung up, <code>capacity</code> set to 0.</li>
<li>The resource host has sent back a chunk of the resource (a new device
channel has been opened)
<ol>
<li>Buffer is not big enough, <code>buffer</code> overwritten up to <code>capacity</code> bytes, and
<code>capacity</code> modified how many more bytes are required</li>
<li>Buffer is big enough, <code>buffer</code> overwritten, <code>capacity</code> unchanged.</li>
</ol>
</li>
</ul>
<h2 id="command-host"><a class="header" href="#command-host"><em>Command</em>: <code>Host</code></a></h2>
<h3 id="variants-int-1"><a class="header" href="#variants-int-1">Variants (<code>int</code>)</a></h3>
<ol start="0">
<li><code>Poll</code> - Poll for more data from server.</li>
<li><code>Hangup</code> - Hang up connection to server.</li>
</ol>
<h3 id="traps-3"><a class="header" href="#traps-3">Traps</a></h3>
<ul>
<li>If variant is unknown (not <code>0</code> or <code>1</code>)</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x03---serve-"><a class="header" href="#0x03---serve-">0x03 - Serve ðŸ§ª</a></h1>
<p>Serve resources over HTTPS.</p>
<p>SSE is expected to be implemented as an abstraction over this API (rather than
be provided as its own portal).</p>
<h2 id="connection-1"><a class="header" href="#connection-1">Connection</a></h2>
<p>Client device channel is opened upon readiness.  The channel allocation should
happen immediately upon return of <code>ar()</code>, and must follow in the order of the
ready list.</p>
<h2 id="readiness-4"><a class="header" href="#readiness-4">Readiness</a></h2>
<p>Becomes ready once either</p>
<ul>
<li>A client connects.</li>
<li>The number of connection errors (with <code>errors</code> being non-null) since the last
successful connetion, in one of the 4 categories has exceeded 255</li>
</ul>
<h2 id="command-serve"><a class="header" href="#command-serve"><em>Command</em>: <code>Serve</code></a></h2>
<h3 id="fields-13"><a class="header" href="#fields-13">Fields</a></h3>
<ul>
<li><code>config: val</code>
<ul>
<li><code>port: half</code> Port number to connect to</li>
<li><code>connections: half</code> How many client connections to attempt maximum
<ul>
<li>If sign bit is set to negative, allow other computers to connection as a
client</li>
</ul>
</li>
</ul>
</li>
<li><code>errors: opt[val]</code> Output number of errors that occured since last successful
connection (or since start, if becoming ready on first success)
<ul>
<li><code>load: byte</code> Number rejected based on load being too high (clients
connecting is larger than ready list size)</li>
<li><code>maximum: byte</code> Number rejected based on too many connections exceeding
maximum set with <code>connections</code></li>
<li><code>https: byte</code> Number rejected for invalid HTTPS</li>
<li><code>timeout: byte</code> Number rejected based on timeout on sending headers</li>
</ul>
</li>
</ul>
<h3 id="traps-4"><a class="header" href="#traps-4">Traps</a></h3>
<ul>
<li>If <code>connections = -32768</code></li>
<li>If <code>port = 0</code> (local only) and <code>connections</code> sign bit is negative</li>
<li>If address at <code>errors + 3</code> has no page</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="device-client-"><a class="header" href="#device-client-"><em>Device</em>: Client ðŸ§ª</a></h1>
<p>Channel representing an HTTPS connection to a client.</p>
<h2 id="type-poll"><a class="header" href="#type-poll"><em>Type</em>: <code>Poll</code></a></h2>
<h3 id="variants-int-2"><a class="header" href="#variants-int-2">Variants (<code>int</code>)</a></h3>
<ol start="0">
<li><code>Continue</code> - Keep polling.</li>
<li><code>Hangup</code> - Hang up connection.</li>
</ol>
<ul>
<li>Respond with informational response status code <code>100-199</code> (FIXME: full list)</li>
<li>Respond with successful response status code <code>200-299</code> (FIXME: full list)</li>
<li>Respond with redirection message status code <code>300-399</code> (FIXME: full list)</li>
<li>Respond with client error response status code <code>400-499</code> (FIXME: full list)</li>
<li>Respond with server error response status code <code>500-599</code> (FIXME: full list)</li>
</ul>
<h2 id="readiness-5"><a class="header" href="#readiness-5">Readiness</a></h2>
<p>Becomes ready once either</p>
<ul>
<li>The client has headers and possible content body ready to be retrieved (no
error is set to 0).</li>
<li>The client has headers, but they are too large for <code>request</code>
(<code>request.capacity</code> set to required capacity)</li>
<li>Errors have overflown (at least one error set to <code>255</code>)</li>
<li>The client hung up (<code>poll</code> set to <code>Hangup</code>)</li>
<li>The client is ready for more data (<code>poll</code> set to <code>Continue</code>)</li>
</ul>
<h2 id="command-client"><a class="header" href="#command-client"><em>Command</em>: <code>Client</code></a></h2>
<h3 id="fields-14"><a class="header" href="#fields-14">Fields</a></h3>
<ul>
<li><code>content: List[byte]</code> Content body to send.</li>
<li><code>poll: opt[Poll]</code> (In/Out) Pointer to poll state (In:Server, Out:Client)</li>
<li><code>request: opt[_]</code> Request buffer
<ul>
<li><code>capacity: ptr[int]</code> (In/Out) Pointer to capacity of <code>headers_content</code>.</li>
<li><code>headers_content: ptr[Text]</code> (In/Out) Pointer to headers and content.</li>
</ul>
</li>
</ul>
<h3 id="traps-5"><a class="header" href="#traps-5">Traps</a></h3>
<ul>
<li>If <code>poll</code> invalid/unknown variant</li>
<li>If <code>poll</code> is not <code>0</code> or <code>1</code> after response headers already sent</li>
<li>If <code>poll</code> is non-null and not a reponse status code before headers sent</li>
<li>If <code>request.size &gt; request.capacity</code></li>
<li>If address at <code>content.addr + content.size</code> has no page</li>
<li>If address at <code>error + 3</code> has no page</li>
<li>If address at <code>request + 7</code> has no page</li>
<li>If address at <code>request.capacity + 3</code>  has no page</li>
<li>If address at <code>request.headers_content.addr + request.capacity</code> has no page</li>
</ul>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x04---speakers-"><a class="header" href="#0x04---speakers-">0x04 - Speakers ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x05---microphone-"><a class="header" href="#0x05---microphone-">0x05 - Microphone ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x06---screen-"><a class="header" href="#0x06---screen-">0x06 - Screen ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x07---camera-"><a class="header" href="#0x07---camera-">0x07 - Camera ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x08---window-"><a class="header" href="#0x08---window-">0x08 - Window ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x09---spawn-"><a class="header" href="#0x09---spawn-">0x09 - Spawn ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x0a---user-"><a class="header" href="#0x0a---user-">0x0A - User ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x0b---preferences-"><a class="header" href="#0x0b---preferences-">0x0B - Preferences ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x0c---system-"><a class="header" href="#0x0c---system-">0x0C - System ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x0d---about-"><a class="header" href="#0x0d---about-">0x0D - About ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x0e---file-"><a class="header" href="#0x0e---file-">0x0E - File ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x0f---hid-"><a class="header" href="#0x0f---hid-">0x0F - Hid ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x10---timer-"><a class="header" href="#0x10---timer-">0x10 - Timer ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x11---clock-"><a class="header" href="#0x11---clock-">0x11 - Clock ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x12---gpu-"><a class="header" href="#0x12---gpu-">0x12 - Gpu ðŸ§ª</a></h1>
<div id="chapter_begin" style="break-before: page; page-break-before: always;"></div><h1 id="0x13---location-"><a class="header" href="#0x13---location-">0x13 - Location ðŸ§ª</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
